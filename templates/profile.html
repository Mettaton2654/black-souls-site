{% extends "base.html" %}

{% block content %}
<h1>Профиль пользователя</h1>
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<div class="profile-container">
    <div class="avatar-section">
        <div class="profile-avatar-large">
            <img src="{{ avatar_url(current_user) }}" alt="avatar" id="avatar-preview">
        </div>
        <p>Текущий аватар</p>
        <div class="avatar-upload">
            <button type="button" id="change-avatar-btn" class="btn btn-sm">Изменить аватар</button>
            <input type="file" id="avatar-input" accept="image/*" style="display: none;">
        </div>
    </div>
    <div id="avatar-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Обрежьте аватар</h3>
            <div class="image-container">
                <img id="avatar-to-crop" src="" alt="Обрезка аватара">
            </div>
            <button type="button" id="crop-avatar-btn" class="btn">Сохранить</button>
        </div>
    </div>

    <form method="POST" action="" enctype="multipart/form-data" class="profile-form">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.username.label }}<br>
            {{ form.username(class="form-control") }}<br>
            {% for error in form.username.errors %}
                <span class="error">[{{ error }}]</span>
            {% endfor %}
        </div>
        <input type="hidden" id="cropped-avatar" name="cropped_avatar">

        <hr>
        <h3>Смена пароля (заполните, если хотите изменить)</h3>

        <div class="form-group">
            {{ form.old_password.label }}<br>
            {{ form.old_password(class="form-control") }}<br>
            {% for error in form.old_password.errors %}
                <span class="error">[{{ error }}]</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.new_password.label }}<br>
            {{ form.new_password(class="form-control") }}<br>
            {% for error in form.new_password.errors %}
                <span class="error">[{{ error }}]</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.confirm_new_password.label }}<br>
            {{ form.confirm_new_password(class="form-control") }}<br>
            {% for error in form.confirm_new_password.errors %}
                <span class="error">[{{ error }}]</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
<script>
let cropper;
const modal = document.getElementById('avatar-modal');
const img = document.getElementById('avatar-to-crop');
const input = document.getElementById('avatar-input');
const btn = document.getElementById('change-avatar-btn');
const closeBtn = document.querySelector('.close');
const cropBtn = document.getElementById('crop-avatar-btn');

btn.onclick = () => input.click();

input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        img.src = e.target.result;
        modal.style.display = 'block';
        img.onload = () => {
            if (cropper) cropper.destroy();
            try {
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    background: false,
                });
                console.log('Cropper initialized');
            } catch (error) {
                console.error('Cropper init error:', error);
                alert('Ошибка загрузки редактора. Проверьте подключение библиотеки.');
            }
        };
    };
    reader.readAsDataURL(file);
};

closeBtn.onclick = () => {
    modal.style.display = 'none';
    if (cropper) cropper.destroy();
};

cropBtn.onclick = () => {
    if (!cropper) {
        alert('Редактор не готов');
        return;
    }

    const canvas = cropper.getCroppedCanvas({
        width: 300,
        height: 300,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });

    canvas.toBlob((blob) => {
        const formData = new FormData();
        formData.append('avatar', blob, 'avatar.png');

        fetch('/upload-avatar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при загрузке: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Ошибка сети');
        })
        .finally(() => {
            modal.style.display = 'none';
            if (cropper) cropper.destroy();
        });
    }, 'image/png');
};

window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = 'none';
        if (cropper) cropper.destroy();
    }
};
</script>
